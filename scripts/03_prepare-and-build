#!/bin/bash

set -e


echo "[PrepareAndBuild] - Starting prepare and build ..."
export PATH="/opt/xbps/usr/bin/:$PATH"

# Entry on right repo
cd /work/void-packages

changedpackages="$CHANGEDPACKAGES"
removedpackages="$REMOVEDPACKAGES"

if [ -z "${changedpackages}" ] && [ -z "${removedpackages}" ]; then
    echo "[PrepareAndBuild] - Nothing has changed, exiting"
    exit 0
fi


if [ -n "$changedpackages" ]; then
    PKGS=$(sudo -Eu builder ./xbps-src sort-dependencies $changedpackages)
else
    PKGS=""
fi

failed=""

for pkg in PKGS; do
    if ! sudo -Eu builder ./xbps-src -j"$(nproc)" ${pkg}; then
        echo "[PrepareAndBuild] - !! build failed for ${pkg}"
        failed="${failed} ${pkg}"
    fi
done

[ -d "/work/void-packages/hostdir" ] && tree /work/void-packages/hostdir

if [ -n "${failed}" ]; then
    echo "[PrepareAndBuild] - build of following packages failed:"
    for f in ${failed}; do
        echo "[PrepareAndBuild] - ${f}"
    done
    exit 1
fi

echo "[PrepareAndBuild] - Starting prepare and prepare OK"
